pipeline {
    agent any

    triggers {
        genericTrigger(
            genericVariables: [
                [key: 'action', value: '$.action'],
                [key: 'pr_number', value: '$.pull_request.number']
            ],
            token: 'UML',
            causeString: 'Triggered by PR #${pr_number}',
            printPostContent: true
        )
    }

    environment {
        IS_MAIN = sh(script: "git rev-parse --abbrev-ref HEAD", returnStdout: true).trim() == 'main'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Run Tests') {
            steps {
                script {
                    if (env.IS_MAIN) {
                        echo "Running Code Coverage Tests..."
                        sh 'mvn verify'
                    } else {
                        echo "Running Unit and Integration Tests..."
                        sh 'mvn test'
                    }
                }
            }
        }
        stage('Generate Jacoco Report') {
            steps {
                script {
                    sh 'mvn jacoco:report'
                    echo "Jacoco report generated"
                }
            }
        }
    }
    post {
        success {
            echo "tests pass!"
        }
        failure {
            echo "tests fail!"
        }
    }
}

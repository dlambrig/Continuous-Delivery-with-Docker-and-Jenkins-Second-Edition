pipeline {
    agent {
        docker {
            image 'gradle:6.7-jdk11'
            args '--user root'
        }
    }

    triggers {
        pollSCM('* * * * *') // Poll GitHub every minute
    }

    stages {
        stage("Verify User") {
            steps {
                sh "whoami"  // Check the user running the script (should be 'root')
                sh "id"  // Verify group memberships
            }
        }

        stage("Compile") {
            steps {
                sh """
                cd Chapter08/sample1
                chmod +x gradlew
                ./gradlew compileJava
                """
            }
        }

        stage("Unit test") {
            steps {
                sh """
                cd Chapter08/sample1
                ./gradlew test
                """
            }
        }

        stage("Code coverage") {
            steps {
                sh """
                cd Chapter08/sample1
                ./gradlew jacocoTestReport
                ./gradlew jacocoTestCoverageVerification
                """
            }
        }

        stage("Static code analysis") {
            steps {
                sh """
                cd Chapter08/sample1
                ./gradlew checkstyleMain
                """
            }
        }

        stage("Package") {
            steps {
                sh """
                cd Chapter08/sample1
                ./gradlew build
                """
            }
        }

        stage("Docker build") {
            steps {
                sh """
                cd Chapter08/sample1
                docker build -t leszko/calculator:${BUILD_TIMESTAMP} .
                """
            }
        }

        stage("Docker login") {
            steps {
                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'docker-hub-credentials',
                               usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
                    sh """
                    cd Chapter08/sample1
                    docker login --username $USERNAME --password $PASSWORD
                    """
                }
            }
        }

        stage("Docker push") {
            steps {
                sh """
                cd Chapter08/sample1
                docker push leszko/calculator:${BUILD_TIMESTAMP}
                """
            }
        }

        stage("Update version") {
            steps {
                sh """
                cd Chapter08/sample1
                sed -i 's/{{VERSION}}/${BUILD_TIMESTAMP}/g' calculator.yaml
                """
            }
        }

        stage("Deploy to staging") {
            steps {
                sh """
                cd Chapter08/sample1
                kubectl config use-context staging
                kubectl apply -f hazelcast.yaml
                kubectl apply -f calculator.yaml
                """
            }
        }

        stage("Acceptance test") {
            steps {
                sleep 60
                sh """
                cd Chapter08/sample1
                chmod +x acceptance-test.sh
                ./acceptance-test.sh
                """
            }
        }

        stage("Release") {
            steps {
                sh """
                cd Chapter08/sample1
                kubectl config use-context production
                kubectl apply -f hazelcast.yaml
                kubectl apply -f calculator.yaml
                """
            }
        }

        stage("Smoke test") {
            steps {
                sleep 60
                sh """
                cd Chapter08/sample1
                chmod +x smoke-test.sh
                ./smoke-test.sh
                """
            }
        }
    }

    post {
        success {
            echo "Pipeline ran perfectly"
        }
        failure {
            echo "Pipeline failure"
        }
    }
}

